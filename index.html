<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#111111">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>COUP: The Resistance</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css?v=2">
    <link rel="stylesheet" href="style_anim.css?v=2">
    <link rel="stylesheet" href="style_pass.css?v=2">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>

    <div id="lobby-screen" class="screen active">
        <h1>COUP</h1>
        <p class="subtitle">Deception | Deduction | Domination</p>
        
        <div class="setup-box" id="setup-box">

            <div class="mode-selector" style="margin-bottom: 20px; text-align: center;">
                <button id="mode-local" class="mode-btn active" onclick="switchMode('local')">Local Play</button>
                <button id="mode-online" class="mode-btn" onclick="switchMode('online')">LAN / Online</button>
            </div>

            <!-- LOCAL PLAY CONTROLS -->
            <div id="local-controls">
                <div class="control-group">
                    <label>Human Players:</label>
                    <select id="human-count">
                    <option value="0">0 (Spectate/AI vs AI)</option>
                    <option value="1" selected>1 (Solo)</option>
                    <option value="2">2 (Pass & Play)</option>
                    <option value="3">3 (Pass & Play)</option>
                    <option value="4">4 (Pass & Play)</option>
                    <option value="5">5 (Pass & Play)</option>
                    <option value="6">6 (Pass & Play)</option>
                </select>
            </div>
            
                <div class="control-group">
                    <label>AI Players:</label>
                    <select id="ai-count">
                        <option value="0">0</option>
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>AI Difficulty:</label>
                    <select id="difficulty">
                        <option value="easy">Easy (Random)</option>
                        <option value="normal">Normal (Balanced)</option>
                        <option value="hard" selected>Hard (Ruthless)</option>
                        <option value="hardcore">Hardcore (God Mode)</option>
                    </select>
                </div>

                <button onclick="startGame()">START GAME</button>
            </div>

            <!-- ONLINE PLAY CONTROLS -->
            <div id="online-controls" class="hidden">
                <div id="online-actions" class="control-group" style="text-align:center;">
                    <div class="control-group" style="text-align: left; margin-bottom: 15px;">
                        <label>Your Name (3-20 chars, no spaces):</label>
                        <input type="text" id="my-player-name" placeholder="Enter Name" maxlength="20" style="width: 100%; box-sizing: border-box; text-align: center; padding: 10px; margin-top: 5px;">
                    </div>

                    <button class="secondary" onclick="initHost()">Create Game (Host)</button>
                    <div style="margin: 10px 0;">- OR -</div>
                    <input type="text" id="host-id-input" placeholder="Paste Room Code Here" style="width: 100%; box-sizing: border-box; text-align: center; margin-bottom: 10px;">
                    <button class="secondary" onclick="joinGame()">Join Game</button>
                    <button class="secondary" onclick="joinGame(true)" style="margin-top:5px; border-color: #888; color: #aaa;">Join as Spectator</button>
                </div>

                <div id="lobby-status" class="hidden" style="margin-top: 20px; border-top: 1px solid #444; padding-top: 10px;">
                    <div id="host-room-info" class="hidden">
                        <p style="font-size: 0.9rem; color: #aaa;">Share this Room Code:</p>
                        <div id="my-room-code" style="font-size: 1.2rem; font-weight: bold; user-select: text; background: #222; padding: 10px; border-radius: 5px; word-break: break-all;">Generating...</div>
                        <button onclick="copyRoomCode()" class="small-btn" style="margin-top:5px;">Copy Code</button>

                        <div class="control-group" style="margin-top: 15px;">
                            <label>AI Bots to Add:</label>
                            <select id="network-ai-count" onchange="updateLobbyList()">
                                <option value="0" selected>0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Difficulty:</label>
                            <select id="network-difficulty">
                                <option value="normal">Normal</option>
                                <option value="hard">Hard</option>
                                <option value="hardcore">Hardcore</option>
                            </select>
                        </div>

                    </div>

                    <h3>Players in Lobby:</h3>
                    <ul id="connected-players-list" style="list-style: none; padding: 0; text-align: left; background: #222; padding: 10px; border-radius: 5px;">
                        <!-- List will be populated by JS -->
                    </ul>

                    <p id="connection-status" style="color: #4CAF50;"></p>

                    <button id="network-start-btn" class="hidden" onclick="startNetworkGame()" style="margin-top: 10px; background: #4CAF50;">START GAME</button>
                </div>
            </div>

            <button id="stats-btn" class="secondary" onclick="showStatsModal()" style="margin-top: 10px;">STATS & ACHIEVEMENTS</button>
            <button class="secondary" onclick="toggleRules()" style="margin-top: 10px;">HOW TO PLAY</button>
            <button class="secondary" onclick="showHistory()" style="margin-top: 10px;">MATCH HISTORY</button>

            <button id="install-pwa-btn" class="secondary" style="margin-top: 10px; display: none; background: #FF9800; color: white;">INSTALL APP</button>
        </div>
    </div>

    <div id="history-screen" class="screen">
        <h1>HISTORY</h1>
        <div id="history-list" style="overflow-y: auto; max-height: 70vh; width: 90%; max-width: 600px; margin: 0 auto; background: #222; padding: 10px; border-radius: 5px;">
            <!-- History Items Injected Here -->
        </div>
        <button onclick="closeHistory()" style="margin-top: 20px; max-width: 200px; align-self: center;">BACK</button>
    </div>

    <div id="game-screen" class="screen">
        <div class="game-header">
            <div id="turn-indicator">Turn: Player 1</div>
            <div id="turn-timer-bar"></div>
            <button class="small-btn" onclick="if(window.audio) window.audio.toggleMute() ? this.innerText='Unmute' : this.innerText='Mute'">Mute</button>
            <button class="small-btn" onclick="toggleRules()">Rules</button>
            <button id="quit-btn" class="small-btn red" onclick="location.reload()">Quit</button>
            <button id="exit-replay-btn" class="small-btn red hidden" onclick="exitReplay()">Exit Replay</button>
        </div>

        <div id="game-log">
            <div class="log-entry system">Welcome to Coup.</div>
        </div>

        <div id="opponents-container">
            </div>

        <div id="player-area">
            <h2 id="active-player-name">Player 1</h2>
            <div class="coins-display"><span id="player-coins">0</span> Coins</div>
            <div id="player-cards" class="cards-container">
                </div>
            
            <div id="action-panel">
                <h3>Select Action</h3>
                <div class="action-grid">
                    <button onclick="submitAction('Income')">Income (1)</button>
                    <button onclick="submitAction('Foreign Aid')">Foreign Aid (2)</button>
                    <button onclick="submitAction('Coup')">Coup (7)</button>
                    <button onclick="submitAction('Tax')">Tax (3) [Duke]</button>
                    <button onclick="submitAction('Assassinate')">Assassinate (3) [Assassin]</button>
                    <button onclick="submitAction('Steal')">Steal [Captain]</button>
                    <button onclick="submitAction('Exchange')">Exchange [Ambassador]</button>
                </div>
            </div>

            <div id="reaction-panel" class="hidden">
                <h3 id="reaction-title">Someone is acting...</h3>
                <div id="reaction-buttons"></div>
            </div>

            <div id="replay-controls" class="hidden" style="display: flex; justify-content: space-around; margin-top: 10px; background: #222; padding: 10px; border-top: 1px solid #444;">
                <button onclick="replayPrev()" style="width: auto;">&lt; Prev</button>
                <span id="replay-step" style="align-self: center;">0 / 0</span>
                <button onclick="replayNext()" style="width: auto;">Next &gt;</button>
            </div>
        </div>
    </div>

    <div id="rules-modal" class="modal hidden">
        <div class="modal-content">
            <h2>How to Play</h2>
            <p><strong>Goal:</strong> Be the last player with influence (face-down cards).</p>
            <ul>
                <li><strong>Income:</strong> Take 1 coin. Cannot be blocked.</li>
                <li><strong>Foreign Aid:</strong> Take 2 coins. Blocked by Duke.</li>
                <li><strong>Coup:</strong> Pay 7 coins. Choose a player to lose a card. Unblockable.</li>
                <li><strong>Tax (Duke):</strong> Take 3 coins.</li>
                <li><strong>Assassinate (Assassin):</strong> Pay 3 coins. Choose player to lose a card. Blocked by Contessa.</li>
                <li><strong>Steal (Captain):</strong> Take 2 coins from another. Blocked by Captain/Ambassador.</li>
                <li><strong>Exchange (Ambassador):</strong> Draw 2 cards, return 2.</li>
            </ul>
            <p><em>If you are caught lying in a challenge, you lose a card. If you are wrongly challenged, the challenger loses a card.</em></p>
            <button onclick="toggleRules()">Close</button>
        </div>
    </div>

    <div id="game-over-modal" class="modal hidden">
        <div class="modal-content" style="text-align: center;">
            <h1 id="winner-name" style="color: gold; margin-bottom: 20px;">WINNER!</h1>
            <p id="game-end-message" style="margin-bottom: 20px;">The game has ended.</p>
            <button onclick="downloadLog()" style="margin-bottom: 10px;">Download Game Log</button>
            <button class="secondary" onclick="showHistoryFromModal()" style="margin-bottom: 10px;">View Match History</button>
            <button class="secondary" onclick="location.reload()">Play Again</button>
        </div>
    </div>

    <!-- PASS & PLAY PRIVACY SCREEN -->
    <div id="pass-device-screen" class="hidden">
        <h1>Pass Device</h1>
        <p>It is now <strong id="next-player-name" style="color: #4CAF50;">Player X</strong>'s turn.</p>
        <p>Pass the device to them properly.</p>
        <button id="i-am-ready-btn">I am Player X</button>
    </div>

    <script src="js/constants.js"></script>
    <script src="js/state.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/network.js"></script>
    <script src="js/core/GameEngine.js"></script>
    <script src="js/core/ActionResolver.js"></script>
    <script src="js/core/ReplayManager.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/stats.js"></script>
    <script src="js/main.js"></script>
</body>
        </html>
        
